<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="913px" height="793px" version="1.1"><defs/><g transform="translate(0.5,0.5)"><rect x="301" y="241" width="610" height="190" rx="29" ry="29" fill="#b9e0a5" stroke="#000000" pointer-events="none"/><g transform="translate(303,248)"><switch><foreignObject pointer-events="all" width="606" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 606px; white-space: normal; text-align: center;">mergeHeap:PriorityQueue</div></foreignObject><text x="303" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="351" y="301" width="120" height="60" rx="9" ry="9" fill="#ccffff" stroke="#000000" pointer-events="none"/><g transform="translate(353,324)"><switch><foreignObject pointer-events="all" width="116" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 116px; white-space: normal; text-align: center;">StreamBuffer</div></foreignObject><text x="58" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="551" y="301" width="120" height="60" rx="9" ry="9" fill="#ccffff" stroke="#000000" pointer-events="none"/><g transform="translate(553,324)"><switch><foreignObject pointer-events="all" width="116" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 116px; white-space: normal; text-align: center;">StreamBuffer</div></foreignObject><text x="58" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="741" y="301" width="120" height="60" rx="9" ry="9" fill="#ccffff" stroke="#000000" pointer-events="none"/><g transform="translate(743,324)"><switch><foreignObject pointer-events="all" width="116" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 116px; white-space: normal; text-align: center;">StreamBuffer</div></foreignObject><text x="58" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="336" y="501" width="150" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#000000" pointer-events="none"/><g transform="translate(338,509)"><switch><foreignObject pointer-events="all" width="146" height="45" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 146px; white-space: normal; text-align: center;">currentMap.<br />destructiveSortedIterator<br />即memIterator</div></foreignObject><text x="73" y="29" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="536" y="501" width="150" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#000000" pointer-events="none"/><g transform="translate(538,509)"><switch><foreignObject pointer-events="all" width="146" height="45" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 146px; white-space: normal; text-align: center;">DiskMapIterator<br />已经排好序，且各value已经按key进行合并</div></foreignObject><text x="73" y="29" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="726" y="501" width="150" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#000000" pointer-events="none"/><g transform="translate(728,524)"><switch><foreignObject pointer-events="all" width="146" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 146px; white-space: normal; text-align: center;">DiskMapIterator</div></foreignObject><text x="73" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 471 331 L 545 331" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 550 331 L 543 335 L 545 331 L 543 328 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 671 331 L 735 331" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 740 331 L 733 335 L 735 331 L 733 328 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 411 361 L 411 501" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 611 361 L 611 501" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 801 361 L 801 501" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 421 L 241 421 L 271 451 L 271 521 L 61 521 L 61 421 Z" fill="#ffe6cc" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 241 421 L 241 451 L 271 451" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(63,434)"><switch><foreignObject pointer-events="all" width="206" height="75" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 206px; white-space: normal;">通过getMorePairs获得相同minKeyHash的所有kv pairs。<br />当StreamBuffer中的数据为空时就会触发调用getMorePairs获得下一拨keyHash的数据</div></foreignObject><text x="103" y="44" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 271 471 L 411 471" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="479" y="121" width="255" height="70" rx="11" ry="11" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(481,126)"><switch><foreignObject pointer-events="all" width="251" height="60" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 251px; white-space: normal; text-align: center;">mergeHeap不断dequene取得最小的minKeyHash对应的所有kv pairs, 通过mergeIfKeyExists对value进行合并，只有key相同的才会进行合并，并从StreamBuffer中移除</div></foreignObject><text x="126" y="36" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="479" y="1" width="255" height="70" rx="11" ry="11" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(481,14)"><switch><foreignObject pointer-events="all" width="251" height="45" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 251px; white-space: normal; text-align: center;">dequene出来的StringBuffer当无数据时getMorePairs获得新数据，然后再enquene到mergeHeap中，当然如果没数据的话就不放进</div></foreignObject><text x="126" y="29" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 606 241 L 606 197" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 606 192 L 610 199 L 606 197 L 603 199 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 607 121 L 607 77" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 607 72 L 610 79 L 607 77 L 603 79 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 479 36 L 411 36 Q 401 36 401 46 L 401 146 Q 401 156 411 156 L 473 156" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 478 156 L 471 160 L 473 156 L 471 153 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="351" y="71" width="80" height="40" fill="none" stroke="none" pointer-events="none"/><g fill="#000000" font-family="Helvetica" text-anchor="middle" font-size="12px"><text x="391" y="95">不断循环直到mergeHeap为空</text></g><rect x="524" y="621" width="175" height="60" rx="9" ry="9" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(526,636)"><switch><foreignObject pointer-events="all" width="171" height="30" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 171px; white-space: normal; text-align: center;">遍历数组批量将数据写到disk文件中</div></foreignObject><text x="86" y="21" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="2" y="731" width="120" height="60" rx="9" ry="9" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(4,754)"><switch><foreignObject pointer-events="all" width="116" height="15" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 116px; white-space: normal; text-align: center;">加入的kv对</div></foreignObject><text x="58" y="14" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 611 621 L 611 601 Q 611 591 611 581 L 611 567" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 611 562 L 615 569 L 611 567 L 608 569 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="184" y="731" width="175" height="60" rx="9" ry="9" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(186,746)"><switch><foreignObject pointer-events="all" width="171" height="30" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 171px; white-space: normal; text-align: center;">currentMap.changeValue<br /> 按key对value进行合并</div></foreignObject><text x="86" y="21" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="524" y="731" width="175" height="60" rx="9" ry="9" fill="#cce5ff" stroke="#000000" pointer-events="none"/><g transform="translate(526,739)"><switch><foreignObject pointer-events="all" width="171" height="45" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.26; vertical-align: top; width: 171px; white-space: normal; text-align: center;">currentMap.<br />destructiveSortedIterator得到按key.hashcode排序好的数组</div></foreignObject><text x="86" y="29" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 612 731 L 612 716 Q 612 706 612 697 L 612 687" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 612 682 L 615 689 L 612 687 L 608 689 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 122 761 L 143 761 Q 153 761 163 761 L 178 761" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 183 761 L 176 765 L 178 761 L 176 758 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 359 761 L 432 761 Q 442 761 452 761 L 518 761" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 523 761 L 516 765 L 518 761 L 516 758 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" text-anchor="middle" font-size="11px"><rect fill="#ffffff" stroke="none" x="375" y="755" width="134" height="15" stroke-width="0"/><text x="442" y="765">currentMap达到spill阈值</text></g><path d="M 292 731 L 407 566" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 410 562 L 409 570 L 407 566 L 403 566 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" text-anchor="middle" font-size="11px"><rect fill="#ffffff" stroke="none" x="217" y="633" width="270" height="29" stroke-width="0"/><text x="352" y="643">数据遍历完后如果currentMap还有值</text><text x="352" y="656">且未spill到disk，则将作为外排的mem Iterator部分</text></g></g></svg>